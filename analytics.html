<html>
<head>
  <title>analytics</title>

</head>
<body>
  <input id = "day" type="text" placeholder="cohort who added email X days ago"/>
  <input id = "left" type="text" placeholder="active starting x days ago"/>
  <input id = "right" type="text" placeholder="active ending y days ago"/>
  <button onclick="usersFromDayWhoAreActiveOverRange()">submit</button>

  <p id = "console">Data will appear here</p>
</body>
</html>

<script>
var base = "https://harvard-food.herokuapp.com/analytics_this-is-a-dangerous-hack"
function httpGETAsync(url, callback)
{
    var xmlHttp = new XMLHttpRequest();
    xmlHttp.onreadystatechange = function() {
        if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
            callback(xmlHttp.responseText);
    }
    xmlHttp.open("GET", url, true); // true for asynchronous
    xmlHttp.send(null);
}

function createTable () {
  var left_bound = 4;
  var right_bound = 2

  if (left_bound > right_bound) {
    httpGETAsync(urlFor(""))
  }
}


function usersFromDayWhoAreActiveOverRange () {
  alert("start");
  var day = document.getElementById('day').value;
  var left = document.getElementById('left').value;
  var right = document.getElementById('right').value;
  alert(day);

  httpGETAsync(urlFor(
    `CREATE TEMP TABLE users_`+day+` AS
      SELECT distinct userId
      , timestamp
      , value
      FROM   logs
      WHERE  EventType LIKE 'AddedEmail'
      AND    timestamp > now() - interval '`+ (day + 1) +`day'
      AND    timestamp < now() - interval '`+ day +` day'
      ORDER BY timestamp DESC;`), function (r){
        alert(r);

        httpGETAsync(urlFor(`
          SELECT DISTINCT o.value,
          (
             SELECT COUNT(value)
             FROM logs AS i
             WHERE o.userId = i.userId
             AND timestamp > now() - interval '`+left+` day'
             AND   timestamp < now() - interval '`+right+` day'
          ) AS active_today
          FROM users_`+ day +` AS o
          ORDER BY active_today DESC;
          `), function (response){
            output(response);
          })
      })

}
function urlFor(query){
  alert(query);

  return base + "?dbquery="+encodeURI(query);
}


function output(str) {
  alert(str);

  document.getElementById("console").textContent=str;
}

</script>
